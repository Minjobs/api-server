<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MURDOO K - à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-overlay: rgba(0, 0, 0, 0.6); 
            --point-gold: #ffd700;
            --text-white: #ffffff;
            --card-white: #ffffff;
            --btn-disabled: #444444;
            --text-disabled: #888888;
            --error-red: #ff4757;
        }
        body { margin: 0; padding: 0; background: #000; font-family: 'Kanit', sans-serif; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .background-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url('/background.jpg'); background-size: cover; opacity: 0.7; }
        
        .container { 
            width: 90%; max-width: 400px; 
            margin: 30px 0 10px 0; 
            background: var(--bg-overlay); 
            border-radius: 30px; 
            padding: 30px 20px; 
            border: 2px solid rgba(255,215,0,0.3); 
            text-align: center; 
            backdrop-filter: blur(15px); 
            box-sizing: border-box; 
        }
        
        .qr-card { background: var(--card-white); border-radius: 25px; padding: 20px; margin: 20px 0; color: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .qr-card img.qr-main { width: 100%; border-radius: 15px; margin-bottom: 15px; }
        .item-info { font-size: 1.2rem; font-weight: 700; color: #1a1a1a; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .price-display { font-size: 1.8rem; font-weight: 700; color: #d32f2f; margin: 5px 0; }
        .receiver-info { font-size: 0.85rem; color: #666; margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px; }

        .steps { text-align: left; background: rgba(255,255,255,0.05); padding: 18px; border-radius: 20px; margin-bottom: 25px; }
        .step-item { font-size: 0.85rem; margin-bottom: 10px; display: flex; gap: 10px; line-height: 1.4; opacity: 0.9; }
        .step-num { background: var(--point-gold); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; font-size: 0.75rem; }

        .upload-area { margin-bottom: 25px; }
        #slipInput { display: none; }
        .upload-label { display: block; background: rgba(255,215,0,0.1); border: 2px dashed var(--point-gold); padding: 15px; border-radius: 15px; cursor: pointer; color: var(--point-gold); font-weight: 500; transition: 0.3s; }
        
        #previewContainer { margin-top: 15px; position: relative; display: none; }
        #slipPreview { width: 100%; max-height: 250px; object-fit: contain; border-radius: 15px; border: 2px solid var(--point-gold); box-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .preview-tag { position: absolute; top: 10px; left: 10px; background: var(--point-gold); color: #000; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 700; }

        .btn { width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.4s; }
        .btn-main { background: var(--btn-disabled); color: var(--text-disabled); cursor: not-allowed; pointer-events: none; }
        .btn-main.active { background: linear-gradient(135deg, var(--point-gold), #f57c00); color: #000; box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4); cursor: pointer; pointer-events: auto; }

        .hidden { display: none; }
        footer { width: 100%; text-align: center; padding: 20px 0; font-size: 0.75rem; opacity: 0.6; font-weight: 300; }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    
    <div class="container">
        <div id="paymentUI">
            <h2 style="color: var(--point-gold); margin-bottom: 5px; font-weight: 700;">à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™ (Checkout)</h2>
            <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 20px;">ìŠ¤ìº” QR ë° ì–´í”Œë¡œë“œ ìŠ¤ë¦½ì„ ìœ„í•´</p>

            <div class="qr-card">
                <div class="item-info">
                    <span id="coinAmountText">--</span> 
                    <span style="font-size: 1.4rem;">ğŸª™</span> 
                </div>
                <div class="price-display" id="bahtAmount">-- THB</div>
                <img src="/qrcode.jpg" class="qr-main" alt="PromptPay QR">
                <div class="receiver-info">ìˆ˜ì·¨ì¸: Miss. ThaiGirl (PromptPay)</div>
            </div>

            <div class="steps">
                <div class="step-item"><div class="step-num">1</div><span><b>ìŠ¤ìº”:</b> ì€í–‰ ì•±ìœ¼ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì†¡ê¸ˆí•˜ì„¸ìš”.</span></div>
                <div class="step-item"><div class="step-num">2</div><span><b>ì €ì¥:</b> ì†¡ê¸ˆ ì™„ë£Œ í›„ ì˜ìˆ˜ì¦(Slip)ì„ ì €ì¥í•˜ì„¸ìš”.</span></div>
                <div class="step-item"><div class="step-num">3</div><span><b>ì—…ë¡œë“œ:</b> ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì˜ìˆ˜ì¦ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</span></div>
            </div>

            <div class="upload-area">
                <input type="file" id="slipInput" accept="image/*" onchange="handleFileSelect(this)">
                <label for="slipInput" class="upload-label" id="uploadLabel">ğŸ“¸ à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ à¸²à¸à¸ªà¸¥à¸´à¸› (ì˜ìˆ˜ì¦ ì„ íƒ)</label>
                
                <div id="previewContainer">
                    <span class="preview-tag">ë¯¸ë¦¬ë³´ê¸°</span>
                    <img id="slipPreview" src="" alt="Slip Preview">
                </div>
            </div>

            <button class="btn btn-main" id="verifyBtn" onclick="processPayment()">à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸¥à¸°à¹€à¸Šà¹‡à¸„à¹€à¸«à¸£à¸µà¸¢à¸ (ê²°ì œ ì™„ë£Œ í™•ì¸)</button>
        </div>

        <div id="successUI" class="hidden">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
            <h2 style="color: var(--point-gold);">à¹€à¸•à¸´à¸¡à¹€à¸«à¸£à¸µà¸¢à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!</h2>
            <p>ì‹œìŠ¤í…œì´ ì…ê¸ˆì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.<br>ì½”ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-main active" onclick="location.href='/'" style="margin-top: 20px;">à¹€à¸£à¸´à¹ˆà¸¡à¸”à¸¹à¸”à¸§à¸‡ (ì‚¬ì£¼ ë³´ëŸ¬ ê°€ê¸°)</button>
        </div>

        <div id="errorUI" class="hidden">
            <div style="font-size: 4rem; margin-bottom: 20px;">âš ï¸</div>
            <h2 style="color: var(--error-red);">à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰</h2>
            <p id="errorMsg">à¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸«à¸£à¸·à¸­à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§<br>ì£¼ë¬¸ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-main active" onclick="location.href='/'" style="margin-top: 20px; background: #555;">ëŒì•„ê°€ê¸° (à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸)</button>
        </div>
    </div>

    <footer>Â© 2026 MURDOO K. à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸«à¹ˆà¸‡à¹‚à¸Šà¸„à¸Šà¸°à¸•à¸²</footer>

    <script>
        const API_KEY = 'wodmfjc8202oj4tnguf9wo2k2jrnjdwow0011k2k2n3nfnnfndsiow901o2kkemrx999dej3j';
        const transactionId = window.location.pathname.split('/').pop();
        let initialCoins = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. ì´ˆê¸° ìœ ì € í”„ë¡œí•„ ë¡œë”©
                const userRes = await fetch('/api/user/profile', { headers: { 'x-api-key': API_KEY } });
                const userData = await userRes.json();
                initialCoins = userData.coins || 0;

                // 2. ê²°ì œ ìƒì„¸ ì •ë³´ ë¡œë”© ë° ìƒíƒœ ê²€ì¦
                const payRes = await fetch(`/api/payment/detail/${transactionId}`, { headers: { 'x-api-key': API_KEY } });
                
                if (!payRes.ok) {
                    const errData = await payRes.json();
                    throw new Error(errData.message || "Invalid Access");
                }

                const payData = await payRes.json();
                
                // ë°ì´í„° ë°”ì¸ë”©
                document.getElementById('coinAmountText').innerText = `${payData.coin_amount} à¹€à¸«à¸£à¸µà¸¢à¸`;
                document.getElementById('bahtAmount').innerText = `${payData.baht_amount} THB`;

            } catch (err) {
                console.error("Access Error:", err);
                // ì˜ëª»ëœ ì ‘ê·¼ ì‹œ UI ì „í™˜
                document.getElementById('paymentUI').classList.add('hidden');
                document.getElementById('errorUI').classList.remove('hidden');
            }
        });

        function handleFileSelect(input) {
            const file = input.files[0];
            const previewContainer = document.getElementById('previewContainer');
            const previewImg = document.getElementById('slipPreview');
            const verifyBtn = document.getElementById('verifyBtn');
            const uploadLabel = document.getElementById('uploadLabel');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                    verifyBtn.classList.add('active');
                    uploadLabel.innerText = "âœ… ë³€ê²½í•˜ê¸° (ì‚¬ì§„ êµì²´)";
                }
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
                verifyBtn.classList.remove('active');
            }
        }

        async function processPayment() {
            const fileInput = document.getElementById('slipInput');
            const btn = document.getElementById('verifyBtn');

            if (!fileInput.files[0]) return;

            btn.classList.remove('active');
            btn.innerText = "à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š... (ê²€ì¦ ì¤‘...)";

            const formData = new FormData();
            formData.append('slip', fileInput.files[0]);
            formData.append('transactionId', transactionId);

            try {
                const res = await fetch('/api/payment/verify-slip', {
                    method: 'POST',
                    headers: { 'x-api-key': API_KEY },
                    body: formData
                });
                const result = await res.json();

                if (res.ok) {
                    const checkRes = await fetch('/api/user/profile', { headers: { 'x-api-key': API_KEY } });
                    const checkData = await checkRes.json();

                    if (checkData.coins > initialCoins) {
                        document.getElementById('paymentUI').classList.add('hidden');
                        document.getElementById('successUI').classList.remove('hidden');
                    } else {
                        alert("ì…ê¸ˆì´ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
                        btn.classList.add('active');
                        btn.innerText = "à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸¥à¸°à¹€à¸Šà¹‡à¸„à¹€à¸«à¸£à¸µà¸¢à¸";
                    }
                } else {
                    alert(result.error || "ê²€ì¦ ì‹¤íŒ¨");
                    btn.classList.add('active');
                    btn.innerText = "à¸¢à¸·à¸™à¸¢à¸±à¸™ê³¼ì²´í¬à¹€à¸«à¸£à¸µà¸¢à¸";
                }
            } catch (e) {
                alert("ì„œë²„ ì—°ê²° ì—ëŸ¬");
                btn.classList.add('active');
            }
        }
    </script>
</body>
</html>
