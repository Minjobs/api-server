<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MURDOO K - à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-overlay: rgba(0, 0, 0, 0.6); 
            --point-gold: #ffd700;
            --text-white: #ffffff;
            --card-white: #ffffff;
        }
        body { margin: 0; padding: 0; background: #000; font-family: 'Kanit', sans-serif; color: #fff; display: flex; justify-content: center; }
        .background-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url('/background.jpg'); background-size: cover; opacity: 0.7; }
        .container { width: 90%; max-width: 400px; margin: 30px 0; background: var(--bg-overlay); border-radius: 30px; padding: 30px 20px; border: 2px solid rgba(255,215,0,0.3); text-align: center; backdrop-filter: blur(15px); }
        
        /* ê²°ì œ ì •ë³´ ì¹´ë“œ */
        .qr-card { background: var(--card-white); border-radius: 25px; padding: 20px; margin: 20px 0; color: #000; }
        .qr-card img { width: 100%; border-radius: 15px; margin-bottom: 15px; }
        .receiver-info { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .price-display { font-size: 1.8rem; font-weight: 700; color: #d32f2f; }

        /* ë‹¨ê³„ë³„ ì•ˆë‚´ */
        .steps { text-align: left; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; margin-bottom: 25px; }
        .step-item { font-size: 0.9rem; margin-bottom: 12px; display: flex; gap: 10px; line-height: 1.4; opacity: 0.9; }
        .step-num { background: var(--point-gold); color: #000; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }

        /* íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ */
        .upload-area { margin-bottom: 25px; }
        #slipInput { display: none; }
        .upload-label { display: block; background: rgba(255,215,0,0.1); border: 2px dashed var(--point-gold); padding: 15px; border-radius: 15px; cursor: pointer; color: var(--point-gold); font-weight: 500; }
        #fileName { font-size: 0.8rem; margin-top: 8px; color: #aaa; }

        .btn { width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .btn-main { background: linear-gradient(135deg, var(--point-gold), #f57c00); color: #000; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
        .btn-main:disabled { background: #555; color: #888; box-shadow: none; }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    <div class="container">
        <div id="paymentUI">
            <h2 style="color: var(--point-gold); margin-bottom: 5px;">à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™ (Checkout)</h2>
            <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 20px;">à¸à¸£à¸¸à¸“à¸²à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸•à¸²à¸¡à¸¢à¸­à¸”à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸</p>

            <div class="qr-card">
                <img src="/qrcode.png" alt="PromptPay QR">
                <div class="receiver-info">ìˆ˜ì·¨ì¸: <span id="receiverName">Miss. ThaiGirl (PromptPay)</span></div>
                <div class="price-display" id="bahtAmount">-- THB</div>
            </div>

            <div class="steps">
                <div class="step-item"><div class="step-num">1</div><span><b>à¸ªà¹à¸à¸™à¸ˆà¹ˆà¸²à¸¢:</b> à¹ƒà¸Šà¹‰à¹à¸­à¸›à¸˜à¸™à¸²à¸„à¸²à¸£à¸ªà¹à¸à¸™ QR à¸«à¸£à¸·à¸­à¹‚à¸­à¸™à¸•à¸²à¸¡à¸¢à¸­à¸”</span></div>
                <div class="step-item"><div class="step-num">2</div><span><b>à¹€à¸à¹‡à¸šà¸ªà¸¥à¸´à¸›:</b> à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸¹à¸›à¸ à¸²à¸à¸«à¸¥à¸±à¸à¸à¸²à¸™ (à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™ QR à¹ƒà¸™à¸ªà¸¥à¸´à¸›)</span></div>
                <div class="step-item"><div class="step-num">3</div><span><b>à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”:</b> à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ªà¸¥à¸´à¸›à¹à¸¥à¹‰à¸§à¸à¸”à¸›à¸¸à¹ˆà¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡</span></div>
            </div>

            <div class="upload-area">
                <input type="file" id="slipInput" accept="image/*" onchange="updateFileName()">
                <label for="slipInput" class="upload-label">ğŸ“¸ à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ à¸²à¸à¸ªà¸¥à¸´à¸› (ì˜ìˆ˜ì¦ ì„ íƒ)</label>
                <div id="fileName">ì•„ì§ ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>

            <button class="btn btn-main" id="verifyBtn" onclick="processPayment()">à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸¥à¸°à¹€à¸Šà¹‡à¸„à¹€à¸«à¸£à¸µà¸¢à¸ (ê²°ì œ ì™„ë£Œ í™•ì¸)</button>
        </div>

        <div id="successUI" class="hidden">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
            <h2 style="color: var(--point-gold);">à¹€à¸•à¸´à¸¡à¹€à¸«à¸£à¸µà¸¢à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!</h2>
            <p>à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¸£à¸±à¸šà¹€à¸‡à¸´à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§<br>à¹€à¸«à¸£à¸µà¸¢à¸à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸–à¸¹à¸ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-main" onclick="location.href='/'" style="margin-top: 20px;">à¹€à¸£à¸´à¹ˆà¸¡à¸”à¸¹à¸”à¸§à¸‡ (ì‚¬ì£¼ ë³´ëŸ¬ ê°€ê¸°)</button>
        </div>
    </div>

    <script>
        const API_KEY = 'wodmfjc8202oj4tnguf9wo2k2jrnjdwow0011k2k2n3nfnnfndsiow901o2kkemrx999dej3j';
        const transactionId = window.location.pathname.split('/').pop();
        let initialCoins = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. ì´ˆê¸° ì½”ì¸ ë³´ìœ ëŸ‰ í™•ì¸
            const userRes = await fetch('/api/user/profile', { headers: { 'x-api-key': API_KEY } });
            const userData = await userRes.json();
            initialCoins = userData.coins || 0;

            // 2. ê²°ì œ ì •ë³´(ê¸ˆì•¡ ë“±) ê°€ì ¸ì˜¤ê¸°
            const payRes = await fetch(`/api/payment/detail/${transactionId}`, { headers: { 'x-api-key': API_KEY } });
            const payData = await payRes.json();
            document.getElementById('bahtAmount').innerText = `${payData.baht_amount} THB`;
        });

        function updateFileName() {
            const file = document.getElementById('slipInput').files[0];
            document.getElementById('fileName').innerText = file ? file.name : "ì•„ì§ ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤";
        }

        async function processPayment() {
            const fileInput = document.getElementById('slipInput');
            const btn = document.getElementById('verifyBtn');

            if (!fileInput.files[0]) {
                alert("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ à¸²à¸à¸ªà¸¥à¸´à¸›à¸à¹ˆà¸­à¸™à¸„à¸£à¸±à¸š (ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”)");
                return;
            }

            btn.disabled = true;
            btn.innerText = "à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š... (ê²€ì¦ ì¤‘...)";

            // [STEP 1] ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ë° ë°±ì—”ë“œ ê²€ì¦ ìš”ì²­
            const formData = new FormData();
            formData.append('slip', fileInput.files[0]);
            formData.append('transactionId', transactionId);

            try {
                const res = await fetch('/api/payment/verify-slip', {
                    method: 'POST',
                    headers: { 'x-api-key': API_KEY },
                    body: formData
                });
                const result = await res.json();

                if (res.ok) {
                    // [STEP 2] ì½”ì¸ì´ ì‹¤ì œë¡œ ëŠ˜ì–´ë‚¬ëŠ”ì§€ ìµœì¢… í™•ì¸
                    const checkRes = await fetch('/api/user/profile', { headers: { 'x-api-key': API_KEY } });
                    const checkData = await checkRes.json();

                    if (checkData.coins > initialCoins) {
                        document.getElementById('paymentUI').classList.add('hidden');
                        document.getElementById('successUI').classList.remove('hidden');
                    } else {
                        alert("ì…ê¸ˆì´ ì•„ì§ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        btn.disabled = false;
                        btn.innerText = "à¸¢à¸·à¸™à¸¢à¸±à¸™ê³¼à¹€à¸Šà¹‡à¸„à¹€à¸«à¸£à¸µà¸¢à¸ (ê²°ì œ ì™„ë£Œ í™•ì¸)";
                    }
                } else {
                    alert(result.error || "ê²€ì¦ ì‹¤íŒ¨");
                    btn.disabled = false;
                    btn.innerText = "à¸¢à¸·à¸™à¸¢à¸±à¸™ê³¼à¹€à¸Šà¹‡à¸„à¹€à¸«à¸£à¸µà¸¢à¸ (ê²°ì œ ì™„ë£Œ í™•ì¸)";
                }
            } catch (e) {
                alert("ì„œë²„ ì—°ê²° ì—ëŸ¬");
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
