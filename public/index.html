<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏≠‡∏î‡∏π K - ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <link rel="stylesheet" href="/css/loading.css">
    <script src="/js/loading.js"></script>

    <style>
        :root {
            --main-gold: #D4AF37;
            --light-gold: #F9D976;
            --bg-navy: #0A192F;
            --glass-white: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-navy);
            color: white;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 450px;
            background: var(--glass-white);
            padding: 40px 30px;
            border-radius: 24px;
            border: 1px solid var(--main-gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        h1 {
            color: var(--main-gold);
            font-size: 1.8rem;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* ÏûÖÎ†• Í∑∏Î£π Ïä§ÌÉÄÏùº */
        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--light-gold);
        }

        input, select {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.07);
            color: white;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
            transition: 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--main-gold);
            background: rgba(255, 255, 255, 0.12);
        }

        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, var(--main-gold), var(--light-gold));
            border: none;
            border-radius: 12px;
            color: #000;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        /* ÌôîÎ©¥ Ï†ÑÌôòÏö© ÌÅ¥ÎûòÏä§ */
        .hidden { display: none; }

        #welcome-msg {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="profile-section" class="hidden">
            <h1>üîÆ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
            <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            
            <form id="register-form">
                <div class="input-group">
                    <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î (ÏÉùÎÖÑÏõîÏùº)</label>
                    <input type="date" id="regBirthDate" required>
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î (ÌÉúÏñ¥ÎÇú ÏãúÍ∞Ñ)</label>
                    <input type="time" id="regBirthTime">
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏û‡∏® (ÏÑ±Î≥Ñ)</label>
                    <select id="regGender">
                        <option value="male">‡∏ä‡∏≤‡∏¢ (ÎÇ®ÏÑ±)</option>
                        <option value="female">‡∏´‡∏ç‡∏¥‡∏á (Ïó¨ÏÑ±)</option>
                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Í∏∞ÌÉÄ)</option>
                    </select>
                </div>
                <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏π‡∏î‡∏ß‡∏á (Ï†ÄÏû• Î∞è ÏãúÏûë)</button>
            </form>
        </div>

        <div id="fortune-section" class="hidden">
            <h1>‚ú® ‡∏´‡∏°‡∏≠‡∏î‡∏π K (Mor Doo K)</h1>
            <div id="welcome-msg">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</div>
            <p>‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏£‡∏≤‡∏ö ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</p>
            
            <button onclick="getFortune()">‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (Ïö¥ÏÑ∏ ÌôïÏù∏ÌïòÍ∏∞)</button>
        </div>
    </div>

    <script>
        let userData = null;

        // Ï¥àÍ∏∞ Ïï± Íµ¨Îèô Î°úÏßÅ
        async function initApp() {
            // Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏™‡∏£‡∏ß‡∏á‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå... üîÆ");

            try {
                // 1. LIFF Ï¥àÍ∏∞Ìôî
                await liff.init({ liffId: "2008959346-MSTYfGPt" });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const userId = profile.userId;

                // 2. ÏÑúÎ≤ÑÏóêÏÑú Îì±Î°ù Ïó¨Î∂Ä ÌôïÏù∏
                const response = await fetch(`/api/check-user/${userId}`);
                const result = await response.json();

                // ÏÑúÎ≤Ñ ÌÜµÏã† ÏôÑÎ£å ÌõÑ Î°úÎî© Ïà®Í∏∞Í∏∞
                Loading.hide();

                if (result.isRegistered) {
                    // [Í∞ÄÏûÖ Ïú†Ï†Ä] ÏÇ¨Ï£º Î≥¥Í∏∞ ÌôîÎ©¥ ÎÖ∏Ï∂ú
                    userData = result.user;
                    document.getElementById('welcome-msg').innerText = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì ${profile.displayName} ‡∏Ñ‡∏£‡∏±‡∏ö`;
                    document.getElementById('fortune-section').classList.remove('hidden');
                } else {
                    // [ÎØ∏Í∞ÄÏûÖ Ïú†Ï†Ä] Í∞ÄÏûÖ Ìèº ÎÖ∏Ï∂ú
                    userData = { userId };
                    document.getElementById('profile-section').classList.remove('hidden');
                }

            } catch (err) {
                Loading.hide();
                console.error("Initialization failed", err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò)");
            }
        }

        // 1. ÌîÑÎ°úÌïÑ Îì±Î°ù ÏöîÏ≤≠
        document.getElementById('register-form').onsubmit = async (e) => {
            e.preventDefault();
            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...");

            const payload = {
                userId: userData.userId,
                birthDate: document.getElementById('regBirthDate').value,
                birthTime: document.getElementById('regBirthTime').value,
                gender: document.getElementById('regGender').value
            };

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! (Îì±Î°ù ÏôÑÎ£å)");
                    location.reload(); // ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏÇ¨Ï£º ÏÑπÏÖòÏúºÎ°ú ÏßÑÏûÖ
                }
            } catch (err) {
                Loading.hide();
                alert("‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Îì±Î°ù Ïã§Ìå®)");
            }
        };

        // 2. ÏÇ¨Ï£º Î∂ÑÏÑù ÏöîÏ≤≠
        async function getFortune() {
            if (!userData) return;

            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI... üîÆ");

            try {
                const res = await fetch('/api/fortune', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (res.ok) {
                    Loading.hide();
                    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! (Í≤∞Í≥ºÎ•º Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§)");
                    liff.closeWindow(); // LIFF Ï∞Ω Îã´Í∏∞
                }
            } catch (err) {
                Loading.hide();
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (Î∂ÑÏÑù Ïò§Î•ò)");
            }
        }

        // Ïï± Ïã§Ìñâ
        initApp();
    </script>
</body>
</html>
