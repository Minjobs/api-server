<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏≠‡∏î‡∏π K - ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <link rel="stylesheet" href="/css/loading.css">
    <script src="/js/loading.js"></script>

    <style>
        :root {
            --main-gold: #D4AF37;
            --light-gold: #F9D976;
            --bg-navy: #0A192F;
            --glass-white: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-navy);
            color: white;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 450px;
            background: var(--glass-white);
            padding: 40px 30px;
            border-radius: 24px;
            border: 1px solid var(--main-gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        h1 {
            color: var(--main-gold);
            font-size: 1.8rem;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* ÏûÖÎ†• Í∑∏Î£π Ïä§ÌÉÄÏùº */
        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--light-gold);
        }

        input, select {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.07);
            color: white;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
            transition: 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--main-gold);
            background: rgba(255, 255, 255, 0.12);
        }

        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, var(--main-gold), var(--light-gold));
            border: none;
            border-radius: 12px;
            color: #000;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        /* ÌôîÎ©¥ Ï†ÑÌôòÏö© ÌÅ¥ÎûòÏä§ */
        .hidden { display: none; }

        #welcome-msg {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="profile-section" class="hidden">
            <h1>üîÆ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
            <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            
            <form id="register-form">
                <div class="input-group">
                    <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î (ÏÉùÎÖÑÏõîÏùº)</label>
                    <input type="date" id="regBirthDate" required>
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î (ÌÉúÏñ¥ÎÇú ÏãúÍ∞Ñ)</label>
                    <input type="time" id="regBirthTime">
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏û‡∏® (ÏÑ±Î≥Ñ)</label>
                    <select id="regGender">
                        <option value="male">‡∏ä‡∏≤‡∏¢ (ÎÇ®ÏÑ±)</option>
                        <option value="female">‡∏´‡∏ç‡∏¥‡∏á (Ïó¨ÏÑ±)</option>
                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Í∏∞ÌÉÄ)</option>
                    </select>
                </div>
                <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏π‡∏î‡∏ß‡∏á (Ï†ÄÏû• Î∞è ÏãúÏûë)</button>
            </form>
        </div>

        <div id="fortune-section" class="hidden">
            <h1>‚ú® ‡∏´‡∏°‡∏≠‡∏î‡∏π K (Mor Doo K)</h1>
            <div id="welcome-msg">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</div>
            <p>‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏£‡∏≤‡∏ö ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</p>
            
            <button onclick="getFortune()">‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (Ïö¥ÏÑ∏ ÌôïÏù∏ÌïòÍ∏∞)</button>
        </div>
    </div>

    <script>
        let userData = null;

    // [1] Ï¥àÍ∏∞ Ïï± Íµ¨Îèô Î°úÏßÅ
    async function initApp() {
        // Ï£ºÎ¨∏ ÏãúÏ†Ñ(Î°úÎî©) Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
        Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤... (Ïö¥Î™ÖÏùò ÏïîÌò∏Î•º ÌôïÏù∏ Ï§ë...) üîÆ");

        try {
            // 1. URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú userId Ï∂îÏ∂ú
            const urlParams = new URLSearchParams(window.location.search);
            const userIdParam = urlParams.get('userId'); // ?userId=ABC1234 ÌòïÌÉú

            // 2. [ÏùòÏßÄ ÌôïÏù∏ Î∞è ÌååÎùºÎØ∏ÌÑ∞ Ï≤¥ÌÅ¨] 
            // ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÎã§Î©¥ Î∞îÎ°ú ÎåÄÎ¨∏(login.html)ÏúºÎ°ú Î≥¥ÎÉÑ
            if (!userIdParam) {
                console.log("Ï†ÑÎã¨Îêú Ïú†Ï†Ä ÏïÑÏù¥ÎîîÍ∞Ä ÏóÜÏäµÎãàÎã§. ÎåÄÎ¨∏ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.");
                Loading.hide();
                window.location.href = "/login.html";
                return; 
            }

            // 3. LIFF Ï¥àÍ∏∞Ìôî (ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏûàÏùÑ ÎïåÎßå ÏßÑÌñâ)
            await liff.init({ liffId: "2008959346-MSTYfGPt" });

            // 4. Î°úÍ∑∏Ïù∏Ïù¥ Ïïà ÎêòÏñ¥ ÏûàÎã§Î©¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú (LIFF Ïù∏Ï¶ù ÌÜ†ÌÅ∞ Í∞±Ïã†Ïö©)
            if (!liff.isLoggedIn()) {
                Loading.hide();
                liff.login(); 
                return;
            }

            // 5. ÏÑúÎ≤ÑÏóêÏÑú Îì±Î°ù Ïó¨Î∂Ä ÌôïÏù∏ (ÌååÎùºÎØ∏ÌÑ∞Î°ú Î∞õÏùÄ userId ÏÇ¨Ïö©)
            // Ïù¥Ï†ú liff.getProfile()ÏùÑ Í∏∞Îã§Î¶¥ ÌïÑÏöî ÏóÜÏù¥ ÌååÎùºÎØ∏ÌÑ∞Î°ú Î∞îÎ°ú Ïè©ÎãàÎã§.
            const response = await fetch(`/api/check-user/${userIdParam}`);
            
            if (!response.ok) throw new Error("ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò");
            
            const result = await response.json();
            Loading.hide();

            if (result.isRegistered) {
                // [Í∞ÄÏûÖ Ïú†Ï†Ä]
                userData = result.user;
                // Ïù¥Î¶ÑÏùÄ LIFF ÌîÑÎ°úÌïÑÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏÑú Î∞òÍ∞ëÍ≤å Ïù∏ÏÇ¨
                const profile = await liff.getProfile();
                document.getElementById('welcome-msg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`;
                document.getElementById('fortune-section').classList.remove('hidden');
            } else {
                // [ÎØ∏Í∞ÄÏûÖ Ïú†Ï†Ä]
                userData = { userId: userIdParam };
                document.getElementById('profile-section').classList.remove('hidden');
            }

        } catch (err) {
            Loading.hide();
            console.error("Init Error:", err);
            alert("Ïó∞Í≤∞ Ïò§Î•ò: " + err.message);
        }
    }

    // [2] ÌîÑÎ°úÌïÑ Îì±Î°ù ÏöîÏ≤≠ Ï≤òÎ¶¨
    document.getElementById('register-form').onsubmit = async (e) => {
        e.preventDefault();
        Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì... (Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë...)");

        const payload = {
            userId: userData.userId,
            birthDate: document.getElementById('regBirthDate').value,
            birthTime: document.getElementById('regBirthTime').value,
            gender: document.getElementById('regGender').value
        };

        try {
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                Loading.hide();
                alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! (Îì±Î°ùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!)");
                location.reload(); // ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏÇ¨Ï£º ÏÑπÏÖòÏúºÎ°ú ÏûêÎèô ÏßÑÏûÖ
            } else {
                throw new Error("ÏÑúÎ≤Ñ Ï†ÄÏû• Ïã§Ìå®");
            }
        } catch (err) {
            Loading.hide();
            console.error("Registration failed", err);
            alert("‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§)");
        }
    };

    // [3] ÏÇ¨Ï£º Î∂ÑÏÑù ÏöîÏ≤≠ Ï≤òÎ¶¨ (AI Ïó∞Îèô)
    async function getFortune() {
        if (!userData) return;

        Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI... (AIÍ∞Ä Ïö¥Î™ÖÏùÑ Î∂ÑÏÑù Ï§ë...) üîÆ");

        try {
            const res = await fetch('/api/fortune', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });

            if (res.ok) {
                Loading.hide();
                alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! (Í≤∞Í≥ºÎ•º ÎùºÏù∏ÏúºÎ°ú Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§!)");
                liff.closeWindow(); // ÏÑ±Í≥µ Ïãú LIFF Ï∞Ω Îã´Í∏∞
            } else {
                throw new Error("Ïö¥ÏÑ∏ Î∂ÑÏÑù ÏÑúÎ≤Ñ Ïò§Î•ò");
            }
        } catch (err) {
            Loading.hide();
            console.error("Fortune API failed", err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§)");
        }
    }

        // 2. ÏÇ¨Ï£º Î∂ÑÏÑù ÏöîÏ≤≠
        async function getFortune() {
            if (!userData) return;

            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏î‡πâ‡∏ß‡∏¢ AI... üîÆ");

            try {
                const res = await fetch('/api/fortune', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (res.ok) {
                    Loading.hide();
                    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! (Í≤∞Í≥ºÎ•º Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§)");
                    liff.closeWindow(); // LIFF Ï∞Ω Îã´Í∏∞
                }
            } catch (err) {
                Loading.hide();
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (Î∂ÑÏÑù Ïò§Î•ò)");
            }
        }

        // Ïï± Ïã§Ìñâ
        initApp();
    </script>
</body>
</html>
