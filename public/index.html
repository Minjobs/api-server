<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏≠‡∏î‡∏π K - ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main-gold: #D4AF37; --bg-navy: #0A192F; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-navy); color: white; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: auto; background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 20px; border: 1px solid var(--main-gold); }
        h1 { color: var(--main-gold); font-size: 1.5rem; margin-bottom: 20px; }
        .input-group { text-align: left; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: linear-gradient(45deg, #D4AF37, #F9D976); border: none; border-radius: 8px; color: #000; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
        .hidden { display: none; }
        #loading { font-size: 1.2rem; color: var(--main-gold); margin-top: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... (Î°úÎî© Ï§ë...)</div>

        <div id="profile-section" class="hidden">
            <h1>üîÆ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <form id="register-form">
                <div class="input-group">
                    <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î (ÏÉùÎÖÑÏõîÏùº)</label>
                    <input type="date" id="regBirthDate" required>
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î (ÌÉúÏñ¥ÎÇú ÏãúÍ∞Ñ)</label>
                    <input type="time" id="regBirthTime">
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏û‡∏® (ÏÑ±Î≥Ñ)</label>
                    <select id="regGender">
                        <option value="male">‡∏ä‡∏≤‡∏¢ (ÎÇ®ÏÑ±)</option>
                        <option value="female">‡∏´‡∏ç‡∏¥‡∏á (Ïó¨ÏÑ±)</option>
                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Í∏∞ÌÉÄ)</option>
                    </select>
                </div>
                <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (ÌîÑÎ°úÌïÑ Ï†ÄÏû•)</button>
            </form>
        </div>

        <div id="fortune-section" class="hidden">
            <h1>üîÆ ‡∏î‡∏π‡∏î‡∏ß‡∏á‡∏Å‡∏±‡∏ö ‡∏´‡∏°‡∏≠‡∏î‡∏π K</h1>
            <p id="welcome-msg"></p>
            <p style="font-size: 0.9rem; color: #888;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏î‡∏ß‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            <button onclick="getFortune()">‡∏î‡∏π‡∏î‡∏ß‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (Ïö¥ÏÑ∏ Î≥¥Í∏∞)</button>
        </div>
    </div>

    <script>
        let userData = null;

        async function initApp() {
            try {
                // 1. LIFF Ï¥àÍ∏∞Ìôî
                await liff.init({ liffId: "2008959346-MSTYfGPt" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const userId = profile.userId;

                // 2. ÏÑúÎ≤ÑÏóêÏÑú Ïú†Ï†Ä ÌôïÏù∏
                const response = await fetch(`/api/check-user/${userId}`);
                const result = await response.json();

                document.getElementById('loading').classList.add('hidden');

                if (result.isRegistered) {
                    // Í∞ÄÏûÖÎêú Ïú†Ï†Ä
                    userData = result.user;
                    document.getElementById('fortune-section').classList.remove('hidden');
                    document.getElementById('welcome-msg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`;
                } else {
                    // Ïã†Í∑ú Ïú†Ï†Ä
                    userData = { userId };
                    document.getElementById('profile-section').classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Ïó∞Í≤∞ (Ïó∞Í≤∞ Ïò§Î•ò)");
            }
        }

        // ÌöåÏõêÍ∞ÄÏûÖ Ï†úÏ∂ú
        document.getElementById('register-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                userId: userData.userId,
                birthDate: document.getElementById('regBirthDate').value,
                birthTime: document.getElementById('regBirthTime').value,
                gender: document.getElementById('regGender').value
            };

            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Ï†ÄÏû• ÏÑ±Í≥µ)");
                location.reload(); // ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ÏÑú ÏÇ¨Ï£º ÏÑπÏÖòÏúºÎ°ú Ïù¥Îèô
            }
        };

        // ÏÇ¨Ï£º Î≥¥Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
        async function getFortune() {
            if (!userData) return;
            
            const res = await fetch('/api/fortune', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });

            if (res.ok) {
                alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE ‡∏Ñ‡∏£‡∏±‡∏ö (Î©îÏãúÏßÄÎ•º Î≥¥ÎÉàÏäµÎãàÎã§)");
                liff.closeWindow();
            }
        }

        initApp();
    </script>
</body>
</html>
