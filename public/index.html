<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏≠‡∏î‡∏π K - ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="/css/loading.css">
    <script src="/js/loading.js"></script>
    <style>
        :root { --main-gold: #D4AF37; --light-gold: #F9D976; --bg-navy: #0A192F; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-navy); color: white; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 450px; background: rgba(255, 255, 255, 0.05); padding: 40px 30px; border-radius: 24px; border: 1px solid var(--main-gold); backdrop-filter: blur(10px); text-align: center; }
        h1 { color: var(--main-gold); margin-bottom: 25px; }
        .input-group { text-align: left; margin-bottom: 20px; }
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(212, 175, 55, 0.3); background: rgba(255, 255, 255, 0.07); color: white; box-sizing: border-box; }
        button { width: 100%; padding: 16px; background: linear-gradient(45deg, var(--main-gold), var(--light-gold)); border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section" class="hidden">
            <h1>‚ú® ‡∏´‡∏°‡∏≠‡∏î‡∏π K</h1>
            <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE ‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <button onclick="loginWithLine()">‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ (Î°úÍ∑∏Ïù∏ÌïòÍ∏∞)</button>
        </div>

        <div id="profile-section" class="hidden">
            <h1>üîÆ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
            <form id="register-form">
                <div class="input-group">
                    <label>ÏÉùÎÖÑÏõîÏùº (‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î)</label>
                    <input type="date" id="regBirthDate" required>
                </div>
                <div class="input-group">
                    <label>ÌÉúÏñ¥ÎÇú ÏãúÍ∞Ñ (‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î)</label>
                    <input type="time" id="regBirthTime">
                </div>
                <div class="input-group">
                    <label>ÏÑ±Î≥Ñ (‡πÄ‡∏û‡∏®)</label>
                    <select id="regGender">
                        <option value="male">‡∏ä‡∏≤‡∏¢</option>
                        <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>
                <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏πÎìú‡∏ß‡∏á (Ï†ÄÏû• ÌõÑ ÏãúÏûë)</button>
            </form>
        </div>

        <div id="fortune-section" class="hidden">
            <h1>‚ú® ‡∏´‡∏°‡∏≠‡∏î‡∏π K</h1>
            <p id="welcome-msg"></p>
            <button onclick="getFortune()">‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (Ïö¥ÏÑ∏ ÌôïÏù∏)</button>
        </div>
    </div>

    <script>
        let userData = null;

        function loginWithLine() {
            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ï‡∏π... üîÆ");
            liff.login();
        }

        async function initApp() {
            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏•‡∏±‡∏á... üîÆ");
            try {
                await liff.init({ liffId: "2008959346-MSTYfGPt" });
                if (!liff.isLoggedIn()) {
                    Loading.hide();
                    document.getElementById('login-section').classList.remove('hidden');
                    return;
                }
                const profile = await liff.getProfile();
                const res = await fetch(`/api/check-user/${profile.userId}`);
                const result = await res.json();
                Loading.hide();

                if (result.isRegistered) {
                    userData = result.user;
                    document.getElementById('welcome-msg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`;
                    document.getElementById('fortune-section').classList.remove('hidden');
                } else {
                    userData = { userId: profile.userId };
                    document.getElementById('profile-section').classList.remove('hidden');
                }
            } catch (err) { Loading.hide(); console.error(err); }
        }

        document.getElementById('register-form').onsubmit = async (e) => {
            e.preventDefault();
            Loading.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            const payload = {
                userId: userData.userId,
                birthDate: document.getElementById('regBirthDate').value,
                birthTime: document.getElementById('regBirthTime').value,
                gender: document.getElementById('regGender').value
            };
            const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (res.ok) location.reload();
        };

        async function getFortune() {
            Loading.show("AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á... üîÆ");
            const res = await fetch('/api/fortune', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(userData) });
            if (res.ok) { Loading.hide(); alert("‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏ô LINE ‡πÅ‡∏•‡πâ‡∏ß! ‚ú®"); liff.closeWindow(); }
        }
        initApp();
    </script>
</body>
</html>
